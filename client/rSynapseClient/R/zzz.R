
# TODO: Add comment
# 
# Author: mfuria
###############################################################################

# For user preferences and other configuration data
.cache <- new.env(parent=emptyenv())

# For Java objects
.jenv <- new.env()

kCertBundle <- "certificateBundle/cacert.pem"

kSupportedLayerCodeMap <- list(
		C = "PhenotypeLayer",
		E = "ExpressionLayer",
		G = "GenotypeLayer",
		M = "Layer"

	)
kSupportedLayerStatus <- c("Curated", "QCd", "Raw")
kSupportedDataLocationTypes <- c("external", "awss3")
kSupportedPlatforms <- list(
		phenotype.data = c("Custom"),
		expression.data = c("affymetrix", "agilent", "illumina", "custom"),
		genotype.data = c("affymetrix", "illumina", "perlegen", "nimblegen", "custom")
	)
	
kSynapseRAnnotationTypeMap <- list(
		stringAnnotations = "character",
		longAnnotations = "integer",
		doubleAnnotations = "numeric",
		dateAnnotations = "POSIXt"
	)
	
kLayerSubtypeMap <- list(
		ExpressionLayer = list(
					affymetrix = "AffyExpressionLayer",
					agilent = "AgilentExpressionLayer",
					illumina = "IlluminaExpressionLayer"
				)
)

## package-local 'getter'
.getCache <-
		function(key)
{
	.cache[[key]]
}

## package-local 'setter'
.setCache <-
		function(key, value)
{
	.cache[[key]] <- value
}

.deleteCache <-
		function(keys)
{
	indx <- which(keys %in% ls(.cache))
	if(length(indx) > 0)
		rm(list=keys[indx], envir=.cache)
}

.onLoad <-
		function(libname, pkgname)
{
	
	.setCache("useJavaClient", FALSE)
	
	if(.getCache("useJavaClient")){
		if(!require(rJava)){
			.setCache("useJavaClient", FALSE)
		}else{
			## Set up rJava
			classpath <- c(list.files(file.path(find.package("synapseClient"), "java"), full.names=TRUE, pattern='jar$', recursive=FALSE))
			.jinit(classpath=classpath)
			# use the non-default text-based progress listener for uploads
			progress <- .jnew("org/sagebionetworks/client/TextProgressListener")
			uploader <- .jnew("org/sagebionetworks/client/DataUploaderMultipartImpl")
			uploader$setProgressListener(progress)
			syn <- .jnew("org/sagebionetworks/client/Synapse")
			syn$setDataUploader(uploader)
			assign("syn", syn, envir=synapseClient:::.jenv)
		}
	}
	synapseResetEndpoints()
	synapseDataLocationPreferences(kSupportedDataLocationTypes)
	.setCache("synapseCacheDir", gsub("[\\]+", "/", path.expand("~/.synapseCache")))
	.setCache("layerCodeTypeMap", kSupportedLayerCodeMap)
	.setCache("layerSubtypeMap", kLayerSubtypeMap)
	.setCache("supportedLayerStatus", kSupportedLayerStatus)
	.setCache("supportedPlatforms", kSupportedPlatforms)
	.setCache("sessionRefreshDurationMin", 60)
	.setCache("curlOpts", list(ssl.verifypeer=TRUE, verbose = FALSE, cainfo=file.path(libname, pkgname, kCertBundle)))
	.setCache("curlHeader", c('Content-Type'="application/json", Accept = "application/json", "Accept-Charset"="utf-8"))
	.setCache("anonymous", FALSE)
	.setCache("downloadSuffix", "unpacked")
	.setCache("debug", FALSE)
	.setCache("curlWriter", getNativeSymbolInfo("_writer_write", PACKAGE="synapseClient")$address)
	.setCache("curlReader", getNativeSymbolInfo("_reader_read", PACKAGE="synapseClient")$address)
	.setCache("annotationTypeMap", kSynapseRAnnotationTypeMap)
	.setCache("synapseBannerPath", file.path(libname, pkgname, "images", "synapse_banner.gif"))
	.setCache("rObjCacheDir", ".R_OBJECTS")
	## install cleanup hooks upon shutdown
	reg.finalizer(topenv(parent.frame()),
								function(...) .Last.lib(),
								onexit=TRUE)
	reg.finalizer(getNamespace("synapseClient"),
								function(...) .Last.lib(),
								onexit=TRUE)
}

.onUnload <- function(libpath) .Last.lib()

.Last.lib <- function(...) {
	try(stoppedStep <- stopStep(), silent=TRUE)
}
